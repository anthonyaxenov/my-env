#!/bin/bash
mv Makefile Makefile.bak

cat << EOF >> Makefile
# Autogenerated at $(date +'%d.%m.%Y %H:%M') using ${BASH_SOURCE[0]}
.DEFAULT_GOAL := help

EOF

for file in ./packs/*; do
    cat ${file} >> Makefile
    echo >> Makefile
done;

for file in ./install/*; do
    name=${file##*/}
    name=${name%.sh}
    desc=$(grep -m 1 -oP "(?<=^##makedesc:\s).*$" ${file})
    [ -z "$desc" ] && desc='<no description>'
    echo -e "##${name}: ${desc}\n${name}:\n\t@${file}\n" >> Makefile
done;

cat << "EOF" >> Makefile
##help: Show this help message
help: Makefile
	@echo "Usage:"
	@echo "\tmake <goal>\t - Install software"
	@echo "\tmake +<goal>\t - Install software"
	@echo "\tmake ^<goal>\t - Upgrade software"
	@echo "\tmake @<goal>\t - Uninstall software"
	@echo "Available goals:"
	@sed -n 's/^##//p' $< | column -ts ':' | sed -e "s/^/\t/"
+%:
	@$(MAKE) $*
^%:
	@./upgrade/$*
@%:
	@./uninstall/$*
EOF

echo "New ./Makefile has been generated!"
echo "Old one has been saved as ./Makefile.bak"
echo
make -s help
